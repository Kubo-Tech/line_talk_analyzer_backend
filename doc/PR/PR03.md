# PR#3: データモデル定義

## 📋 概要
APIのリクエスト/レスポンスモデルを定義し、Pydanticを使用した型安全なデータモデルを実装しました。全てのモデルに対して網羅的な単体テストを作成し、コードカバレッジ99%を達成しました。

## 🎯 目的
- APIのリクエスト/レスポンスの型定義
- Pydanticによるバリデーション機能の実装
- 型安全性の確保（mypy完全対応）
- 仕様書通りのデータ構造の実現

## 🔧 変更内容

### 1. app/models/__init__.py
- データモデルパッケージの初期化
- 全モデルクラスのエクスポート
- `__all__`による公開APIの明示化

### 2. app/models/request.py
- **AnalyzeRequestモデル**の実装
  - `top_n`: 取得する上位単語数（1-1000、デフォルト: 50）
  - `min_word_length`: 最小単語長（1-10、デフォルト: 1）
  - `exclude_parts`: 除外品詞（カンマ区切り文字列、オプション）
- **バリデーション機能**
  - Pydantic Fieldによる範囲チェック（ge, le）
  - カスタムバリデータ（`validate_exclude_parts`）による正規化処理
  - 空白除去とカンマ区切りの正規化
- **ヘルパーメソッド**
  - `get_exclude_parts_list()`: 除外品詞をリストで取得

### 3. app/models/response.py
- **単語解析関連モデル**
  - `WordAppearance`: 単語の出現情報（日時、ユーザー、メッセージ）
  - `TopWord`: 上位単語情報（単語、出現回数、品詞、出現情報リスト）
  - `MorphologicalAnalysis`: 形態素解析結果（上位単語リスト）

- **メッセージ解析関連モデル**
  - `MessageAppearance`: メッセージの出現情報（日時、ユーザー、メッセージ、一致タイプ）
  - `TopMessage`: 上位メッセージ情報（完全一致/部分一致/合計カウント、出現情報リスト）
  - `MessageAnalysisResult`: メッセージ全文解析結果（上位メッセージリスト）

- **統合レスポンスモデル**
  - `AnalysisPeriod`: 解析期間（開始日、終了日）
  - `WordAnalysisResult`: 単語解析結果データ（期間、統計、形態素解析、メッセージ解析）
  - `AnalysisResult`: 解析成功レスポンス（status: "success"）

- **エラーレスポンスモデル**
  - `ErrorDetail`: エラー詳細（コード、メッセージ）
  - `ErrorResponse`: エラーレスポンス（status: "error"）

- **型安全性の特徴**
  - Literal型による厳密なステータス制御（"success" / "error"）
  - Literal型による一致タイプ制御（"exact" / "partial"）
  - Fieldによる値の範囲制限（ge=0, ge=1等）
  - default_factoryによる安全なリスト初期化

### 4. tests/unit/test_models.py
- **AnalyzeRequestのテスト**（12テスト）
  - デフォルト値の検証
  - カスタム値の設定
  - top_n/min_word_lengthの境界値バリデーション（最小値/最大値）
  - 除外品詞の正規化処理（空白除去、空文字列処理）
  - 除外品詞リスト取得メソッド
  - JSONシリアライズ/デシリアライズ

- **レスポンスモデルのテスト**（21テスト）
  - WordAppearance/TopWord/MorphologicalAnalysis
  - MessageAppearance/TopMessage/MessageAnalysisResult
  - AnalysisPeriod/WordAnalysisResult/AnalysisResult
  - ErrorDetail/ErrorResponse
  - 各モデルのインスタンス化
  - バリデーションエラー検証
  - 一致タイプの厳密な制御（Literal型）
  - JSONシリアライズ動作確認

### 5. .gitignoreの更新
- Python関連の一時ファイルを追加
  - `__pycache__/`, `*.py[cod]`, `*$py.class`, `*.so`
  - `.Python`
- pytest関連ファイルを追加
  - `.pytest_cache/`, `.coverage`, `htmlcov/`
- mypy関連ファイルを追加
  - `.mypy_cache/`, `.dmypy.json`, `dmypy.json`

### 6. 依存パッケージのインストール
- pytest関連パッケージの追加（requirements-ci.txtから）
  - `pytest==8.3.4`
  - `pytest-cov==6.0.0`
  - `pytest-asyncio==0.24.0`

## ✅ テスト結果

全てのテスト項目をクリアしました：

- [x] **単体テスト**: 33テスト全てパス
  ```bash
  $ pytest tests/unit/test_models.py -v
  collected 33 items
  tests/unit/test_models.py::TestAnalyzeRequest::test_default_values PASSED
  tests/unit/test_models.py::TestAnalyzeRequest::test_custom_values PASSED
  ...（中略）...
  tests/unit/test_models.py::TestErrorResponse::test_json_serialization PASSED
  ========== 33 passed in 0.80s ==========
  ```

- [x] **コードカバレッジ**: 99%達成
  ```
  Name                     Stmts   Miss  Cover   Missing
  ------------------------------------------------------
  app/models/__init__.py       3      0   100%
  app/models/request.py       19      1    95%   40
  app/models/response.py      45      0   100%
  ------------------------------------------------------
  TOTAL                       67      1    99%
  ```

- [x] **コード品質チェック**: 全て成功
  ```bash
  $ black --check app/models/ tests/unit/test_models.py
  All done! ✨ 🍰 ✨

  $ isort --check-only --profile=black --line-length=100 app/models/ tests/unit/
  # エラーなし

  $ flake8 app/models/ tests/unit/test_models.py [options]
  # エラーなし

  $ mypy app/models/ tests/unit/test_models.py --config-file=mypy.ini
  Success: no issues found in 4 source files
  ```

- [x] **型アノテーション**: 完全対応
  - 全ての関数・メソッドに型ヒント記載
  - mypyの厳格な型チェックをクリア
  - Pydantic BaseModelによる実行時型検証

- [x] **Docstring**: 完全記載
  - Google Style docstringを全てのモジュール・クラス・関数に記載
  - flake8-docstringsのチェックをクリア

## 📊 実装したモデルの階層構造

```
AnalysisResult (成功レスポンス)
└── WordAnalysisResult
    ├── AnalysisPeriod
    ├── MorphologicalAnalysis
    │   └── TopWord[]
    │       └── WordAppearance[]
    └── MessageAnalysisResult
        └── TopMessage[]
            └── MessageAppearance[]

ErrorResponse (エラーレスポンス)
└── ErrorDetail
```

## 📝 備考

### 設計上の工夫
- **Literal型の活用**: ステータスや一致タイプを文字列リテラルで制約し、型安全性を向上
- **default_factory**: リストのデフォルト値にミュータブルオブジェクトを安全に使用
- **Fieldによる制約**: 数値の範囲制限をPydanticレベルで実施
- **カスタムバリデータ**: 除外品詞文字列の正規化を自動化

### テストの網羅性
- 正常系・異常系・境界値を全てカバー
- Pydanticのバリデーションエラーを適切にテスト
- JSONシリアライズ/デシリアライズの動作確認
- 型安全性を損なう操作の検証（type: ignore付き）

### 仕様書との整合性
- SPEC.md 3.2節「APIレスポンス形式」に完全準拠
- サンプルJSONと完全に一致する構造
- エラーレスポンス形式も仕様通り実装

## 🔗 関連Issue
SPEC.mdの実装計画PR#3に基づく作業です。

## 📊 次のステップ
PR#4（LINEトーク履歴パーサーの実装）またはPR#5（形態素解析サービスの実装）に進む準備が整いました。これらは並列実行可能です。
