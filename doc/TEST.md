# テスト戦略

## テストレベル

| レベル         | ツール                   | カバレッジ目標          |
| -------------- | ------------------------ | ----------------------- |
| ユニットテスト | pytest                   | 80%以上                 |
| 統合テスト     | pytest + TestClient      | 主要フロー100%          |
| E2Eテスト      | pytest + 実データ        | クリティカルパス100%    |

## ユニットテスト対象

- **サービス層**
  - `parser.py`: LINEトーク履歴のパース、日付行/メッセージ行の解析、マルチライン対応
  - `morphological.py`: MeCab形態素解析、品詞フィルタリング
  - `word_counter.py`: 単語カウント、メッセージカウント、表層形/基本形の扱い
  - `analyzer.py`: 統合解析処理、レスポンス生成
  - `demo_service.py`: デモモード判定、デモレスポンス生成

- **モデル**
  - `request.py`: リクエストモデル、バリデーション
  - `response.py`: レスポンスモデル、データ構造

- **設定**
  - `config.py`: 環境変数読み込み、デフォルト値、シングルトン

## 統合テスト対象

- **エンドポイント**
  - GET `/`: ルートエンドポイント
  - GET `/api/v1/health`: ヘルスチェック
  - POST `/api/v1/analyze`: トーク履歴解析
    - 正常系: ファイルアップロード、パラメータ指定、日付範囲指定
    - 異常系: ファイルなし、不正形式、空ファイル、サイズ超過
    - エラーハンドリング: サーバーエラー、バリデーションエラー

- **CORS設定**
  - クロスオリジンリクエストの検証

- **デモモード**
  - デモファイルの検出と処理
  - 通常ファイルとの動作比較

## E2Eテスト対象

1. **デモモード**
   - デモファイルアップロード → 遅延 → デモレスポンス返却
   - レスポンス一貫性の確認
   - 遅延時間の検証
   - レスポンス形式の検証

2. **実データ解析**
   - 実際のLINEトーク履歴ファイルの解析
   - 期間指定での解析（2025年データ）
   - 全期間解析
   - ユーザー別解析結果の検証

## テストデータ

- **最小データセット**: 1日分、2ユーザー、10メッセージ
- **標準データセット**: 1ヶ月分、3ユーザー、500メッセージ
- **大規模データセット**: 1年分、5ユーザー、10000メッセージ
- **異常データセット**: 不正フォーマット、特殊文字、空ファイル、不正エンコーディング

## テストカバレッジ目標

- ユニットテスト: 80%以上
- 統合テスト: 主要フロー100%
- E2Eテスト: クリティカルパス100%

## CI/CD

- **トリガー**: mainブランチへのPR、mainへのpush
- **実行内容**:
  - isortチェック（コード整形確認）
  - flake8（Lintチェック）
  - mypy（型チェック）
  - pytest（全テスト実行）
  - カバレッジレポート生成・アップロード

## テスト実行方法

```bash
# 全テスト実行
pytest

# カバレッジ付き実行
pytest --cov=app --cov-report=html

# 特定レベルのみ実行
pytest tests/unit/
pytest tests/integration/
pytest tests/e2e/

# 特定ファイルのみ実行
pytest tests/unit/test_parser.py

# 詳細出力
pytest -v
```
