# Issue#13: Android版とiPhone版の通話メッセージの違いに対応

## 概要

Android版とiPhone版のLINEトーク履歴では、通話関連メッセージの形式が異なることが判明。両方のOSで正しくシステムメッセージを除外できるようにパーサーを修正した。

## 発見された問題

### 1. ☎記号の有無

**iPhone版**:
```
☎ 不在着信
☎ 通話に応答がありませんでした
☎ 通話時間 0:38
☎ 通話をキャンセルしました
☎ グループ通話が開始されました。
```

**Android版**:
```
不在着信
通話に応答がありませんでした
通話時間 2:49
通話をキャンセルしました。
```

→ Android版では☎記号が出力されない

### 2. グループ通話の種別

**iPhone版**:
```
☎ グループ通話が開始されました。
グループ通話が終了しました。  （発言者なし）
```

**Android版**:
```
グループ音声通話が開始されました。
グループビデオ通話が開始されました。
グループ通話が終了しました。  （発言者あり）
```

→ Android版では音声通話とビデオ通話を区別し、終了時に発言者が表示される

### 3. 末尾の句点の違い

一部のメッセージで句点（。）の有無が異なる場合がある。

## 修正内容

### 1. `/app/app/services/parser.py`

通話関連メッセージのパターンを正規表現で柔軟に対応：

```python
META_PATTERNS = [
    # ... 既存のパターン ...
    
    # 通話関連（iPhone/Android両対応）
    r"^☎?\s?不在着信$",  # ☎は任意
    r"^☎?\s?通話に応答がありませんでした。?$",  # ☎と末尾の。は任意
    r"^☎?\s?通話時間 \d+:\d+$",
    r"^☎?\s?通話をキャンセルしました。?$",
    
    # グループ通話（種別を区別）
    r"^☎?\s?グループ(音声|ビデオ)?通話が開始されました。$",  # 音声/ビデオは任意
    r"^☎?\s?グループ通話が終了しました。$",
]
```

**ポイント**:
- `☎?`: ☎記号を任意に（0回または1回）
- `\s?`: 空白を0個または1個（意図しない複数空白を除外）
- `(音声|ビデオ)?`: 音声・ビデオの区別を任意に
- `。?`: 末尾の句点を任意に

### 2. `/app/doc/RULE.md`

通話関連メッセージの表を更新し、iPhone版とAndroid版の両方の例を記載：

| パターン | 例（iPhone版） | 例（Android版） |
|---------|--------------|----------------|
| 不在着信 | `☎ 不在着信` | `不在着信` |
| 応答なし通知 | `☎ 通話に応答がありませんでした` | `通話に応答がありませんでした` |
| 通話時間記録 | `☎ 通話時間 0:38` | `通話時間 2:49` |
| 通話キャンセル通知 | `☎ 通話をキャンセルしました` | `通話をキャンセルしました。` |
| グループ通話開始通知 | `☎ グループ通話が開始されました。` | `グループ音声通話が開始されました。`<br>`グループビデオ通話が開始されました。` |
| グループ通話終了通知 | `グループ通話が終了しました。` | `グループ通話が終了しました。` |

### 3. `/app/tests/unit/test_parser.py`

新規テスト3件を追加：

1. **`test_parse_android_call_messages`** (9行のメッセージで2行のみ抽出)
   - Android版の通話メッセージ（☎なし、音声/ビデオ区別）が正しく除外されることを確認
   - 通常のメッセージのみが抽出されることを確認

2. **`test_parse_mixed_iphone_android_call_messages`** (10行のメッセージで2行のみ抽出)
   - iPhone版とAndroid版の通話メッセージが混在する場合の動作確認
   - 両方のパターンが正しく除外されることを確認

3. **`test_parse_group_call_end_without_user`** (3行のメッセージで1行のみ抽出)
   - iPhone版のグループ通話終了メッセージ（発言者なし）の処理確認
   - ユーザー名が空の場合はシステムメッセージとして除外されることを確認

## テスト結果

### 既存のテスト

```bash
$ pytest tests/unit/test_parser.py -v
================================== 29 passed in 0.36s ==================================
```

- 既存の26テスト + 新規3テスト = 29テストすべて成功
- 既存機能への影響なし

### 追加したテスト

```bash
$ pytest tests/unit/test_parser.py::TestLineMessageParser::test_parse_android_call_messages \
         tests/unit/test_parser.py::TestLineMessageParser::test_parse_mixed_iphone_android_call_messages \
         tests/unit/test_parser.py::TestLineMessageParser::test_parse_group_call_end_without_user -v
================================== 3 passed in 0.34s ===================================
```

- 3つの新規テストすべて成功

### 全体テスト

```bash
$ pytest tests/ -v
================================ 238 passed, 2 failed in 45.56s ==========================
```

- 今回の変更に関するテスト: すべて成功（パーサー29件）
- 失敗した2件は既存のバグ（半角カタカナの判定）で今回の変更とは無関係

## 対応したメッセージパターン

### iPhone版のみ
- ☎記号付きの通話メッセージ
- グループ通話終了時に発言者なし

### Android版のみ
- ☎記号なしの通話メッセージ
- グループ音声通話/グループビデオ通話の区別
- グループ通話終了時に発言者あり

### 両方に対応
- 不在着信
- 通話に応答がありませんでした
- 通話時間記録
- 通話をキャンセルしました
- グループ通話開始通知（種別あり/なし）
- グループ通話終了通知

## 影響範囲

- **修正ファイル**: 2ファイル
  - `app/services/parser.py`: 正規表現パターンの更新
  - `doc/RULE.md`: ドキュメントの更新
- **テストファイル**: 1ファイル
  - `tests/unit/test_parser.py`: 新規テスト3件追加
- **後方互換性**: ✅ 完全に保たれている
- **既存機能への影響**: ❌ なし

## 期待される効果

- Android版のトーク履歴でも通話メッセージが正しく除外される
- iPhone版のトーク履歴でも引き続き正常に動作する
- OS混在のグループトークでも正しく処理される
- ユーザーが使用するOSに依存しない安定した解析結果

## 今後の課題

- 他のOSバージョンでのメッセージ形式の違いが発見された場合、追加対応が必要
- LINE Webなど他のプラットフォームでのトーク履歴形式も調査が必要かもしれない

---

**Issue作成日**: 2025-12-30  
**対応優先度**: 高（ユーザーの約半数がAndroid使用のため）  
**完了日**: 2025-12-30
