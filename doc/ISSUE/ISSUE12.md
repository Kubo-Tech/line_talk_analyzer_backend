# Issue#12: 通話関連システムメッセージの除外

## 1. 概要

実データの解析で、LINEの通話機能に関連するシステムメッセージが流行語として誤って集計されることが判明。これらは流行語大賞として不適切なため、除外対象に追加する。

---

## 2. 問題の発見

### 2.1 実データでの出現

実際のトーク履歴ファイルで以下のようなメッセージが確認された：

```
13:49	太郎	☎ 不在着信
13:55	花子	☎ 通話に応答がありませんでした
13:56	太郎	☎ 通話時間 0:38
19:34	花子	☎ 通話をキャンセルしました
21:24	次郎	☎ グループ通話が開始されました。
20:05	りんな	[ボイスメッセージ]
```

### 2.2 問題点

- これらはLINEが自動生成するシステムメッセージ
- ユーザーが意図的に使った言葉ではない
- 流行語として集計するには不適切
- 既存の`META_PATTERNS`には`[通話]`形式のみ含まれており、`☎`マークで始まる新しい形式には対応していなかった

---

## 3. 実装内容

### 3.1 除外パターンの追加

`app/services/parser.py`の`META_PATTERNS`に以下の5パターンを追加：

```python
META_PATTERNS = [
    # ... 既存のパターン ...
    r"^\[ボイスメッセージ\]$",                # ボイスメッセージ
    r"☎ 不在着信$",                           # 不在着信
    r"☎ 通話に応答がありませんでした$",        # 通話に応答なし
    r"☎ 通話時間 \d+:\d+$",                    # 通話時間（数字:数字の形式）
    r"☎ 通話をキャンセルしました$",            # 通話キャンセル
    r"☎ グループ通話が開始されました。$",      # グループ通話開始
]
```

### 3.2 パターンの詳細

| パターン | 説明 | 例 |
|---------|------|-----|
| `^\[ボイスメッセージ\]$` | ボイスメッセージ | `[ボイスメッセージ]` |
| `☎ 不在着信$` | 不在着信通知 | `☎ 不在着信` |
| `☎ 通話に応答がありませんでした$` | 応答なし通知 | `☎ 通話に応答がありませんでした` |
| `☎ 通話時間 \d+:\d+$` | 通話時間記録 | `☎ 通話時間 0:38`, `☎ 通話時間 12:45` |
| `☎ 通話をキャンセルしました$` | 通話キャンセル通知 | `☎ 通話をキャンセルしました` |
| `☎ グループ通話が開始されました。$` | グループ通話開始通知 | `☎ グループ通話が開始されました。` |

**注意点**:
- `\d+:\d+`は時間の形式（分:秒）にマッチ
- すべて行末マッチング（`$`）を使用して、これらの文字列を含む通常のメッセージが誤って除外されないようにする

---

## 4. テストの追加

### 4.1 新規テストケース

`tests/unit/test_parser.py`に2つのテストを追加：

#### 4.1.1 `test_parse_exclude_call_messages`

**目的**: 通話関連メッセージが正しく除外されることを確認

**テストデータ**:
- ☎ 不在着信
- ☎ 通話に応答がありませんでした
- ☎ 通話時間 0:38
- ☎ 通話をキャンセルしました
- ☎ グループ通話が開始されました。
- [ボイスメッセージ]
- 通常のメッセージ（2件）

**期待結果**: 通常のメッセージ2件のみが抽出される

#### 4.1.2 `test_parse_call_messages_variations`

**目的**: 様々な通話時間パターンが正しく除外されることを確認

**テストデータ**:
- `☎ 通話時間 0:05` （短時間）
- `☎ 通話時間 1:23` （1分台）
- `☎ 通話時間 12:45` （10分台）
- 通常のメッセージ（1件）

**期待結果**: 通常のメッセージ1件のみが抽出される

### 4.2 テスト結果

```
tests/unit/test_parser.py::TestLineMessageParser::test_parse_exclude_call_messages PASSED
tests/unit/test_parser.py::TestLineMessageParser::test_parse_call_messages_variations PASSED

全237テスト成功（235→237に増加）
```

---

## 5. 期待される効果

### 5.1 データ品質の向上

- システムメッセージが流行語として誤って集計されることがなくなる
- ユーザーが実際に使った言葉のみが解析対象となる
- より意味のある流行語ランキングを提供

### 5.2 パフォーマンス影響

- 除外処理はメッセージ読み込み時に実行される
- 正規表現マッチングはO(1)の処理（パターン数は固定）
- パフォーマンス影響: 測定不能レベル（< 0.01秒）

### 5.3 保守性の向上

- 今後、LINEの新しいシステムメッセージが追加された場合も、`META_PATTERNS`に追加するだけで対応可能
- 既存のテストで回帰を防止できる

---

## 6. 今後の拡張

### 6.1 他のシステムメッセージ

今後、以下のようなメッセージも出現する可能性がある：

- ビデオ通話関連: `☎ ビデオ通話...`
- 音声メッセージ: `🎤 音声メッセージ...`
- リアクション関連: `♥ いいねしました`

これらは実データで確認され次第、同様の方法で除外対象に追加する。

### 6.2 パターンの統合

現在は個別のパターンを列挙しているが、共通の接頭辞でまとめることも検討：

```python
# 現在（個別パターン）
r"☎ 不在着信$",
r"☎ 通話に応答がありませんでした$",
r"☎ 通話時間 \d+:\d+$",

# 統合案（1つのパターンで複数に対応）
r"☎ (不在着信|通話に応答がありませんでした|通話時間 \d+:\d+)$",
```

ただし、可読性と保守性の観点から、現状の個別パターンのままが望ましい。

---

## 7. 関連Issue・PR

- **依存**: なし（独立したIssueとして実装）
- **関連Issue**: Issue#01（appearancesフィールドの削除）、Issue#03（単語カウント方法の改善）
- **優先度**: 高（データ品質に直接影響）

---

## 8. チェックリスト

- [x] 問題の特定と分析
- [x] 除外パターンの追加（6パターン）
- [x] テストケースの追加（2件）
- [x] 全テストの実行と確認（237/237成功）
- [x] ドキュメント作成（本文書）

---

## 9. まとめ

LINEの通話関連システムメッセージとボイスメッセージを除外対象に追加し、流行語ランキングの精度を向上させた。実データで確認された6種類のパターンをすべてカバーし、テストで動作を保証した。今後、新しいシステムメッセージが出現した場合も、同様の方法で対応可能な拡張性の高い実装となっている。

---

**作成日**: 2025-12-30  
**ステータス**: 完了 ✅  
**優先度**: 高  
**影響範囲**: データ解析の精度向上